(function(a){"use strict";a.URL=a.URL||a.webkitURL;if(a.Blob&&a.URL)try{new Blob();return;}catch(b){}var c=a.BlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder||(function(a){var b=function(a){return Object.prototype.toString.call(a).match(/^\[object\s(.*)\]$/)[1];},c=function d(){this.data=[];},e=function f(a,b,c){this.data=a;this.size=a.length;this.type=b;this.encoding=c;},g=c.prototype,h=e.prototype,i=a.FileReaderSync,j=function(a){this.code=this[this.name=a];},k=("NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR "+"NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR").split(" "),l=k.length,m=a.URL||a.webkitURL||a,n=m.createObjectURL,o=m.revokeObjectURL,p=m,q=a.btoa,r=a.atob,s=a.ArrayBuffer,t=a.Uint8Array,u=/^[\w-]+:\/*\[?[\w\.:-]+\]?(?::[0-9]+)?/;e.fake=h.fake=true;while(l--)j.prototype[k[l]]=l+1;if(!m.createObjectURL)p=a.URL=function(a){var b=document.createElementNS("http://www.w3.org/1999/xhtml","a"),c;b.href=a;if(!("origin" in b))if(b.protocol.toLowerCase()==="data:")b.origin=null;else{c=a.match(u);b.origin=c&&c[1];}return b;};p.createObjectURL=function(a){var b=a.type,c;if(b===null)b="application/octet-stream";if(a instanceof e){c="data:"+b;if(a.encoding==="base64")return c+";base64,"+a.data;else if(a.encoding==="URI")return c+","+decodeURIComponent(a.data);if(q)return c+";base64,"+q(a.data);else return c+","+encodeURIComponent(a.data);}else if(n)return n.call(m,a);};p.revokeObjectURL=function(a){if(a.substring(0,5)!=="data:"&&o)o.call(m,a);};g.append=function(a){var c=this.data;if(t&&(a instanceof s||a instanceof t)){var d="",f=new t(a),g=0,h=f.length;for(;g<h;g++)d+=String.fromCharCode(f[g]);c.push(d);}else if(b(a)==="Blob"||b(a)==="File")if(i){var k=new i();c.push(k.readAsBinaryString(a));}else throw new j("NOT_READABLE_ERR");else if(a instanceof e){if(a.encoding==="base64"&&r)c.push(r(a.data));else if(a.encoding==="URI")c.push(decodeURIComponent(a.data));else if(a.encoding==="raw")c.push(a.data);}else{if(typeof a!=="string")a+="";c.push(unescape(encodeURIComponent(a)));}};g.getBlob=function(a){if(!arguments.length)a=null;return new e(this.data.join(""),a,"raw");};g.toString=function(){return "[object BlobBuilder]";};h.slice=function(a,b,c){var d=arguments.length;if(d<3)c=null;return new e(this.data.slice(a,d>1?b:this.data.length),c,this.encoding);};h.toString=function(){return "[object Blob]";};h.close=function(){this.size=0;delete this.data;};return c;}(a));a.Blob=function(a,b){var d=b?(b.type||""):"";var e=new c();if(a)for(var f=0,g=a.length;f<g;f++)if(Uint8Array&&a[f] instanceof Uint8Array)e.append(a[f].buffer);else e.append(a[f]);var h=e.getBlob(d);if(!h.slice&&h.webkitSlice)h.slice=h.webkitSlice;return h;};var d=Object.getPrototypeOf||function(a){return a.__proto__;};a.Blob.prototype=d(new a.Blob());}(typeof self!=="undefined"&&self||typeof window!=="undefined"&&window||this.content||this));var saveAs=saveAs||(function(a){"use strict";if(typeof navigator!=="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent))return;var b=a.document,c=function(){return a.URL||a.webkitURL||a;},d=b.createElementNS("http://www.w3.org/1999/xhtml","a"),e="download" in d,f=function(a){var b=new MouseEvent("click");a.dispatchEvent(b);},g=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),h=a.webkitRequestFileSystem,i=a.requestFileSystem||h||a.mozRequestFileSystem,j=function(b){(a.setImmediate||a.setTimeout)(function(){throw b;},0);},k="application/octet-stream",l=0,m=500,n=function(b){var d=function(){if(typeof b==="string")c().revokeObjectURL(b);else b.remove();};if(a.chrome)d();else setTimeout(d,m);},o=function(a,b,c){b=[].concat(b);var d=b.length;while(d--){var e=a["on"+b[d]];if(typeof e==="function")try{e.call(a,c||a);}catch(f){j(f);}}},p=function(a){if(/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type))return new Blob(["\ufeff",a],{type:a.type});return a;},q=function(b,j,m){if(!m)b=p(b);var q=this,r=b.type,s=false,t,u,v=function(){o(q,"writestart progress write writeend".split(" "));},w=function(){if(u&&g&&typeof FileReader!=="undefined"){var d=new FileReader();d.onloadend=function(){var a=d.result;u.location.href="data:attachment/file"+a.slice(a.search(/[,;]/));q.readyState=q.DONE;v();};d.readAsDataURL(b);q.readyState=q.INIT;return;}if(s||!t)t=c().createObjectURL(b);if(u)u.location.href=t;else{var e=a.open(t,"_blank");if(e==undefined&&g)a.location.href=t;}q.readyState=q.DONE;v();n(t);},x=function(a){return function(){if(q.readyState!==q.DONE)return a.apply(this,arguments);};},y={create:true,exclusive:false},z;q.readyState=q.INIT;if(!j)j="download";if(e){t=c().createObjectURL(b);d.href=t;d.download=j;setTimeout(function(){f(d);v();n(t);q.readyState=q.DONE;});return;}if(a.chrome&&r&&r!==k){z=b.slice||b.webkitSlice;b=z.call(b,0,b.size,k);s=true;}if(h&&j!=="download")j+=".download";if(r===k||h)u=a;if(!i){w();return;}l+=b.size;i(a.TEMPORARY,l,x(function(a){a.root.getDirectory("saved",y,x(function(a){var c=function(){a.getFile(j,y,x(function(a){a.createWriter(x(function(c){c.onwriteend=function(b){u.location.href=a.toURL();q.readyState=q.DONE;o(q,"writeend",b);n(a);};c.onerror=function(){var a=c.error;if(a.code!==a.ABORT_ERR)w();};"writestart progress write abort".split(" ").forEach(function(a){c["on"+a]=q["on"+a];});c.write(b);q.abort=function(){c.abort();q.readyState=q.DONE;};q.readyState=q.WRITING;}),w);}),w);};a.getFile(j,{create:false},x(function(a){a.remove();c();}),x(function(a){if(a.code===a.NOT_FOUND_ERR)c();else w();}));}),w);}),w);},r=q.prototype,s=function(a,b,c){return new q(a,b,c);};if(typeof navigator!=="undefined"&&navigator.msSaveOrOpenBlob)return function(a,b,c){if(!c)a=p(a);return navigator.msSaveOrOpenBlob(a,b||"download");};r.abort=function(){var a=this;a.readyState=a.DONE;o(a,"abort");};r.readyState=r.INIT=0;r.WRITING=1;r.DONE=2;r.error=r.onwritestart=r.onprogress=r.onwrite=r.onabort=r.onerror=r.onwriteend=null;return s;}(typeof self!=="undefined"&&self||typeof window!=="undefined"&&window||this.content));if(typeof module!=="undefined"&&module.exports)module.exports.saveAs=saveAs;else if((typeof define!=="undefined"&&define!==null)&&(define.amd!=null))define([],function(){return saveAs;});csvWriter=function(a,b){this.del=a||',';this.enc=b||'"';this.escapeCol=function(a){if(isNaN(a))if(!a)a='';else{a=String(a);if(a.length>0){a=a.split(this.enc).join(this.enc+this.enc);a=this.enc+a+this.enc;}}return a;};this.arrayToRow=function(a){var b=a.slice(0);var c,d=b.length;for(c=0;c<d;c++)b[c]=this.escapeCol(b[c]);return b.join(this.del);};this.arrayToCSV=function(a){var b=a.slice(0);var c,d=b.length;for(c=0;c<d;c++)b[c]=this.arrayToRow(b[c]);return b.join("\r\n");};};partial=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){var c=Array.prototype.slice.call(arguments);return a.apply(null,b.concat(c));};};logging=(function(){var a={error:[10,'ERROR'],warn:[20,'WARNING'],info:[30,'INFO'],debug:[40,'DEBUG']};var b={error:console.error,warn:console.warn,info:console.info,debug:console.log};var c=function(c,d,e){if(d in a&&a[d][0]<=c)try{b[d](e);}catch(f){console.log(a[d][1]+': '+e);}};return function(b){if(b==undefined||!(b in a))b=a.info[0];else b=a[b][0];return{error:partial(c,b,'error'),warn:partial(c,b,'warn'),info:partial(c,b,'info'),debug:partial(c,b,'debug')};};})();var logger=logging('warn');rand_int=function(a,b){if(a===null||a===undefined)a=0;else a=a+0;if(b===null||b===undefined)b=4294967296;else b=b+1;b=b-a;return Math.floor(Math.random()*b)+a;};isInt=function(a){return /^[\-0-9]+$/.test(a);};average=function(a){var b={mean:0,variance:0,deviation:0},c=a.length;for(var d,e=0,f=c;f--;e+=a[f]);for(d=b.mean=e/c,f=c,e=0;f--;e+=Math.pow(a[f]-d,2));return b.deviation=Math.sqrt(b.variance=e/c),b;};mode=function(a){if(a.length==0)return null;var b={};var c=a[0],d=1;for(var e=0;e<a.length;e++){var f=a[e];if(b[f]==null)b[f]=1;else b[f]++;if(b[f]>d){c=f;d=b[f];}}return c;};decimalToHex=function(a){var b=Number(a).toString(16).toUpperCase();b="#000000".substr(0,7-b.length)+b;return b;};decimalToRGBA=function(a,b){return 'rgba('+((a&0xff0000)>>>16)+','+(((a&0x00ff00)>>>8)|0)+','+((a&0x0000ff)|0)+','+b+')';};convertToAssociative=function(a){var b=a.length;var c={};for(var d=0;d<b;d++)if(a[d]!=undefined)c[a[d]]=a[d];return c;};isAssociativeEmpty=function(a){var b;for(b in a)if(a.hasOwnProperty(b))return false;return true;};associativeLength=function(a){var b=0;for(var c in a)if(Object.hasOwnProperty.call(a,c))b++;return b;};popAssociative=function(a){for(var b in a){if(!Object.hasOwnProperty.call(a,b))continue;var c=[b,a[b]];if(!delete a[b])throw new Error();return c;}};MJD_to_date=function(a){var b=new Date();b.setTime((a-40587)*86400000);return b;};MJD_to_date_string=function(a){var b=MJD_to_date(a);return b.getUTCFullYear()+'/'+(b.getUTCMonth()+1)+'/'+b.getUTCDate();};MJD_to_month_string=function(a){var b=MJD_to_date(a);return b.getUTCFullYear()+'/'+(b.getUTCMonth()+1);};function fisher_yates(a){var b=a.length,c,d,e;if(b==0)return false;while(--b){c=Math.floor(Math.random()*(b+1));d=a[b];e=a[c];a[b]=e;a[c]=d;}}file_loader=(function(a){var b={download_file:function(a){if(!isAssociativeEmpty(a.waiting)){var c=popAssociative(a.waiting);var d=c[0];var e=c[1];if(d in a.in_progress||d in a.succeeded_files||d in a.failed_files)return b.download_file(a);a.in_progress[d]=true;log.info('in_progress: '+JSON.stringify(a.in_progress));a.downloader(e,partial(b.success_callback,a,d),partial(b.error_callback,a,d));}},success_callback:function(a,c,d){if(d===undefined)a.failed_files[c]=false;else a.succeeded_files[c]=d;delete a.in_progress[c];log.info('in_progress: '+JSON.stringify(a.in_progress));if(!isAssociativeEmpty(a.waiting)){if(a.running)b.download_file(a);}else if(isAssociativeEmpty(a.in_progress)){log.info('done with downloads');a.callback(a.succeeded_files,a.failed_files);}else log.info('done, but not all finished');},error_callback:function(a,c,d){a.failed_files[c]=d;delete a.in_progress[c];log.info('in_progress: '+JSON.stringify(a.in_progress));if(!isAssociativeEmpty(a.waiting)){if(a.running)b.download_file(a);}else if(isAssociativeEmpty(a.in_progress)){log.info('done with downloads');a.callback(a.succeeded_files,a.failed_files);}else log.info('done, but not all finished');}};var c={start:function(a){log.info(a);a.running=true;for(var c=0;c<a.parallel;c++)b.download_file(a);},stop:function(a){a.running=false;}};function d(b){b=a.extend({waiting:{},in_progress:{},succeeded_files:{},failed_files:{},parallel:4,running:false,downloader:function(a,b,c){c(false);},callback:function(a,b){return;}},b);return b;}return function(b){var e=d(b);return function(b){if(c[b])return c[b].apply(this,[e].concat(Array.prototype.slice.call(arguments,1)));else a.error('Method '+b+' does not exist on file_loader');};};})(jQuery);load_css=(function(a){return function(b,c,d){if(typeof d=='undefined')d=false;if(d)b+='?_ts='+new Date().getTime();a('<link>',{rel:'stylesheet',type:'text/css','href':b}).on('load',function(){if(typeof c=='function')c();}).appendTo('head');};})(jQuery);var popup=(function(a){var b=null;var c={ok:function(){var c=a(this).data('options');if(c.ok!=null)if(c.innerhtml!=null)c.ok();else c.ok(a(this).find('input[type=text]').val());a(this).fadeOut(function(){a(this).remove();});b=null;return false;},cancel:function(){var c=a(this).data('options');if(c.cancel!=null)if(c.innerhtml!=null)c.cancel();else c.cancel(a(this).find('input[type=text]').val());a(this).fadeOut(function(){a(this).remove();});b=null;return false;}};var d={ok:function(b){var c=a(this).data('options');if(b!=undefined&&b!=null)c.ok=b;else c.ok=null;},cancel:function(b){var c=a(this).data('options');if(b!=undefined&&b!=null)c.cancel=b;else c.cancel=null;},getObj:function(){return a(this).find('div.inner');}};var e=function(d){d=a.extend({ok:null,cancel:null,title:'Edit:',button:'Save',value:'',innerhtml:null,height:null,width:null},d);if(b!=null){a('.popup').fadeOut(function(){a(this).remove();});b=null;}a('body').append('<div class="popup"></div><div class="popup_inner"></div>');var e=a('div.popup').filter(':last');a(e).data('options',d);var f=a('div.popup_inner').filter(':last');var g=null;var h=null;if(d.height!=null){if(d.height=='auto')g=10;else g=parseFloat(d.height.slice(0,-2),10)/2;a(f).css('height',d.height);}if(d.width!=null){if(d.width!='auto')h=parseFloat(d.width.slice(0,-2),10)/2;a(f).css('width',d.width);}if(h!=null||g!=null){if(h==null)h=12.5;if(g==null)g=3.5;a(f).css('margin','-'+g+'em 0 0 -'+h+'em');}if(d.innerhtml!=null)a(f).append('<h2>'+d.title+'</h2>'+d.innerhtml+'<button>'+d.button+'</button>');else{a(f).append('<h2>'+d.title+'</h2><input type="text" /><button>'+d.button+'</button>');var i=a(f).find('input[type=text]');i.val(d.value);a(i).css('margin-right','.5em');}var j=a(f).find('button');a(f).on('keydown','input',function(b){var c=(b.keyCode?b.keyCode:b.which);if(c==13){a(j).trigger('click');return false;}});a(j).on('click',function(){c.ok.apply(e);a(f).remove();});a(f).on('click',function(){return false;});a(e).on('click',function(){c.cancel.apply(e);a(f).remove();});a(f).show();b=true;return a(e);};return function(b){var c=e(b);return function(b){if(d[b])return d[b].apply(c,Array.prototype.slice.call(arguments,1));else a.error('Method '+b+' does not exist on popup');};};})(jQuery);bytearray=(function(){var a={isset:function(a,b){if(Math.ceil(b/8)>a.length)return false;else return !!(a[Math.floor(b/8)].charCodeAt(0)&(1<<(b%8)));},sum:function(a){var b=0;for(var c=0;c<a.length;c++)for(var d=0;d<8;d++)if(a[c].charCodeAt(0)&(1<<d))b++;return b;}};return function(b){var c={length:b.length*8};for(var d in a)c[d]=partial(a[d],b);return c;};})();json_decode_helper=(function(a){var b={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var c="";var d,e,f,g,h,i,j;var k=0;a=b._utf8_encode(a);while(k<a.length){d=a.charCodeAt(k++);e=a.charCodeAt(k++);f=a.charCodeAt(k++);g=d>>2;h=((d&3)<<4)|(e>>4);i=((e&15)<<2)|(f>>6);j=f&63;if(isNaN(e))i=j=64;else if(isNaN(f))j=64;c=c+this._keyStr.charAt(g)+this._keyStr.charAt(h)+this._keyStr.charAt(i)+this._keyStr.charAt(j);}return c;},decode:function(a){var c="";var d,e,f;var g,h,i,j;var k=0;a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(k<a.length){g=this._keyStr.indexOf(a.charAt(k++));h=this._keyStr.indexOf(a.charAt(k++));i=this._keyStr.indexOf(a.charAt(k++));j=this._keyStr.indexOf(a.charAt(k++));d=(g<<2)|(h>>4);e=((h&15)<<4)|(i>>2);f=((i&3)<<6)|j;c=c+String.fromCharCode(d);if(i!=64)c=c+String.fromCharCode(e);if(j!=64)c=c+String.fromCharCode(f);}c=b._utf8_decode(c);return c;},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");var b="";for(var c=0;c<a.length;c++){var d=a.charCodeAt(c);if(d<128)b+=String.fromCharCode(d);else if((d>127)&&(d<2048)){b+=String.fromCharCode((d>>6)|192);b+=String.fromCharCode((d&63)|128);}else{b+=String.fromCharCode((d>>12)|224);b+=String.fromCharCode(((d>>6)&63)|128);b+=String.fromCharCode((d&63)|128);}}return b;},_utf8_decode:function(a){var b="";var c=0;var d=c1=c2=0;while(c<a.length){d=a.charCodeAt(c);if(d<128){b+=String.fromCharCode(d);c++;}else if((d>191)&&(d<224)){c2=a.charCodeAt(c+1);b+=String.fromCharCode(((d&31)<<6)|(c2&63));c+=2;}else{c2=a.charCodeAt(c+1);c3=a.charCodeAt(c+2);b+=String.fromCharCode(((d&15)<<12)|((c2&63)<<6)|(c3&63));c+=3;}}return b;}};var c=function(a){try{return window.atob(a);}catch(c){try{return b.decode(a);}catch(c){logger.warn('failed base64 decoding');return a;}}};var d={'binary':function(a){logger.debug('binary');return c(a);},'SuperDST':function(a){logger.debug('SuperDST');return SuperDST(a);},'RecoPulseSeriesMapMask':function(a){logger.debug('RecoPulseSeriesMapMask');return RecoPulseSeriesMapMask(a);},'RecoPulseSeriesMapUnion':function(a){logger.debug('RecoPulseSeriesMapUnion');return RecoPulseSeriesMapUnion(a);},'bytearray':function(a){logger.debug('bytearray');return bytearray(c(a));},'bytearray_list':function(a){logger.debug('bytearray_list');var b=[];for(var d=0;d<a.length;d++)b.push(bytearray(c(a[d])));return b;}};return function e(b){var c={};if('__jsonclass__' in b)c=d[b.__jsonclass__[0]](b.__jsonclass__[1]);else for(var f in b){if(!Object.hasOwnProperty.call(b,f))continue;var g=b[f];var h=a.type(g);if(h=='object')g=e(g);else if(h=='array'){var i=[];for(var j=0;j<g.length;j++)i.push(e(g[j]));g=i;}c[f]=g;}return c;};})(jQuery);var partial=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){var c=Array.prototype.slice.call(arguments);return a.apply(null,b.concat(c));};};var raw_helpers=(function(){"use strict";var a=function(a){return a>64&&a<91?a-65:a>96&&a<123?a-71:a>47&&a<58?a+4:a===43?62:a===47?63:0;};var b=function(b,c){var d=b.replace(/[^A-Za-z0-9\+\/]/g,""),e=d.length,f=c?Math.ceil((e*3+1>>2)/c)*c:e*3+1>>2,g=new Uint8Array(f);for(var h,i,j=0,k=0,l=0;l<e;l++){i=l&3;j|=a(d.charCodeAt(l))<<18-6*i;if(i===3||e-l===1){for(h=0;h<3&&k<f;h++,k++)g[k]=j>>>(16>>>h&24)&255;j=0;}}return g;};var c={header:function(a,b,d){if(b in d){if(d[b].tracking)c.uint32(a);}else{var e=c.uint8(a);var f=c.uint8(a);if(e)c.uint32(a);d[b]={tracking:e,version:f};}},uint8:function(a){var b=a.data.getUint8(a.index,true);a.index+=1;return b;},uint16:function(a){var b=a.data.getUint16(a.index,true);a.index+=2;return b;},uint32:function(a){var b=a.data.getUint32(a.index,true);a.index+=4;return b;},String:function(a){var b=c.uint32(a);var d='';for(var e=0;e<b;e++)d+=String.fromCharCode(c.uint8(a));return d;}};var d=function(a,b){var c=Math.max(0,b-a.length);var d=Math.pow(10,c).toString().substr(1);return d+a;};return{decodeB64:function(a){return b(a).buffer;},readers:c,zeroPad:d};})();SuperDST=(function(){"use strict";var a=0x8000;var b=0x4000;var c=8;var d=0x00ff;var e=6;var f=0x3f00;var g=0x7fff;var h=2;var i=13;var j=0x1fff;var k=3;var l=0xe000;var m=2;var n=-512.0;var o={};var p=jQuery.extend(raw_helpers.readers,{SizeCodec:function(a){p.header(a,'SizeCodec',o);var b=p.uint8(a);var c=0;if(b<0xff-8)c=b;else{var d=0xff-b;var e=null;for(var f=0;f<d;f++){e=p.uint8(a);c+=e*Math.pow(2,f*8);}if(c>=Math.pow(2,53))throw "SizeCodec is too big to properly represent in JS";}return c;},DOMHeader:function(a){var b=p.uint16(a);return{dom_id:(b&j),slop:(b&l)>>i};},ChargeStamp:function(e){var h=p.uint16(e);return{stamp:{rel_time:(h&d),charge:(h&f)>>c,hlc_bit:!!(h&b),stop:!!(h&a)},overflow:{code:(h&g),stop:!!(h&a)},raw:h};},CompactVector:function(a,b){p.header(a,b,o);var c=p.SizeCodec(a);var d=[];for(var e=0;e<c;e++)d.push(p[b](a));return d;}});var q=(function(){var a={DecodeRun:function(a,b,c){var d=0,e=0;for(var f=b;f<c;f++){d|=(((a[f]&0xf0)>>4)&0x0f)<<e;e+=4;}var g=[];for(var f=0;f<d;f++)g.push(a[b]&0xf0);return g;},Decode:function(b){var c=[];var d=0,e=1;for(d=0;e<b.length;e++)if((b[e]&0x0f)!=(b[d]&0x0f)){var f=a.DecodeRun(b,d,e);for(var g=0;g<f.length;g++)c.push(f);d=e;}if(e==b.length){var f=a.DecodeRun(b,d,e);for(var g=0;g<f.length;g++)c.push(f);}return c;}};return a;})();var r=function(a){return{string:((a&0x1fc0)>>6)&0x007f,om:(a&0x003f)+1};};var s=function(a){var b=0.0;var c=a.chargecode_+a.charge_overflow_;var d=a.version_;var e=a.charge_format_;var f=9.0/0x3fff;if(a.mode=='LOG')b=Math.pow(10.0,c*f-2.0);else if(d==0)b=c*0.15;else b=c*0.05+0.025;return b;};var t=function(a,b,c,d,e,f){return{timecode_:a,chargecode_:b,widthcode_:c,kind_:d,charge_format_:e,charge_overflow_:0,version_:f};};var u=function(a){o={};var b={buf:raw_helpers.decodeB64(a),index:0};b.data=new DataView(b.buf);var d="";for(var f=0;f<12;f++)d+=raw_helpers.zeroPad(p.uint8(b).toString(16),2);var g=p.CompactVector(b,'ChargeStamp');var h=p.CompactVector(b,'DOMHeader');var i=[q.Decode(p.CompactVector(b,'uint8')),q.Decode(p.CompactVector(b,'uint8')),q.Decode(p.CompactVector(b,'uint8')),q.Decode(p.CompactVector(b,'uint8'))];var j=p.CompactVector(b,'uint8');var l=0;var m=(1<<(c+k))-1;var n=(0x1<<c)-1;var s=(0x1<<e)-1;var u=[];var v=null,w=null,x=null;var y=0;for(var f=0;f<h.length;f++){v=h[f];if(y>=g.length)throw "charge stamp out of range";w=g[y];if(isNaN(w.raw))throw 'stamp is NaN';var z={om_:{},stamps_:[],kind_:'HLC',start_time_:0.0,time_overflow_:0.0};z.om_=r(v.dom_id);var A=w.stamp.hlc_bit;var B=w.stamp.stop;var C=i[(z.om_.om>60?2:0)+(A?1:0)];var D=0;var E=w.stamp.rel_time;var F=w.stamp.charge;E|=(v.slop<<c);var G=(z.om_.om>60)?'log':'linear';if(E==m)do{y+=1;w=g[y];E+=w.raw;}while(w.raw==0xffff);if(G=='linear'&&F==s)do{y+=1;w=g[y];F+=w.raw;}while(w.raw==0xffff);else if(G=='log'){if(l>=j.length)throw "extra_bytes out of range";F|=j[l]<<e;l+=1;}if(D>=C.length)throw "pulse widths out of range";z.stamps_.push(t(E,F,C[D],A,G,1));D+=1;while(!B){y+=1;if(y>=g.length)throw "charge stamp out of range";w=g[y];if(isNaN(w.raw))throw 'stamp is NaN';if(G!='linear')throw "charge format must be linear for multiple stamps";if(w.stamp.hlc_bit!=A)throw "hlc bit must be the same for multiple stamps";E=w.stamp.rel_time;F=w.stamp.charge;B=w.stamp.stop;if(E==n)do{y+=1;w=g[y];E+=w.raw;}while(w.raw==0xffff);if(G=='linear'&&F==s)do{y+=1;w=g[y];F+=w.raw;}while(w.raw==0xffff);if(D>=C.length)throw "pulse widths out of range2";z.stamps_.push(t(E,F,C[D],A,'linear',1));D+=1;}y+=1;z.kind_=A?'HLC':'SLC';u.push(z);}if(y!=g.length)throw "did not use all charge stamps";var H=0.0;for(var f=0;f<u.length;f++){if(u[f].stamps_.length<=0)throw "missing stamps in a readout";H+=u[f].stamps_[0].timecode_+u[f].time_overflow_;u[f].start_time_=H;}return{readouts_:u,masked_:null};};var v={Apply:function(a,b){if(a.masked_!=null)return a.masked_;var c=[];var d={};var e=null,f=0.0,g={},h=null;for(var i=0;i<a.readouts_.length;i++){e=a.readouts_[i];if(e.om_.om<=0){console.warn('readout has bad om'+(e.om_.om));continue;}g=[];f=e.start_time_;if(e.stamps_.length>0)g.push({time:f,charge:s(e.stamps_[0])});else{console.warn('readout has no length');continue;}for(var j=1;j<e.stamps_.length;j++){f+=e.stamps_[j].timecode_;g.push({time:f,charge:s(e.stamps_[j])});}h=e.om_.string*1000+e.om_.om;if(h in d)c[d[h]].data=c[d[h]].data.concat(g);else{d[e.om_.string*1000+e.om_.om]=c.length;c.push({string:e.om_.string,om:e.om_.om,pmt:0,data:g});}}for(var i=0;i<c.length;i++)c[i].data.sort(function(a,b){return a.time-b.time;});c.sort(function(a,b){if(a.string!=b.string)return a.string-b.string;else return a.om-b.om;});a.masked_=c;return c;}};return function(a){try{var b=u(a);}catch(c){throw c;throw "SuperDSTError ("+c+")";}var d={};for(var e in v)d[e]=partial(v[e],b);return d;};})();RecoPulseSeriesMapMask=(function(){"use strict";var a={};var b=jQuery.extend(raw_helpers.readers,{bitmask:function(a){var d=b.uint16(a);var e=b.uint8(a);var f=[];for(var g=0;g<d;g++)f.push(b.uint8(a));return c({size_:d,padding_:e,mask_:f});},OMKeyMask:function(c){b.header(c,'OMKeyMask',a);return b.bitmask(c);},ElementMasks:function(c){b.header(c,'ElementMasks',a);var d=[];var e=b.uint32(c);for(var f=0;f<e;f++)d.push(b.bitmask(c));return d;}});var c=(function(){var a={size:function(a){return 8*a.size_-a.padding_;},get:function(a,b){if(b<0||b>=(8*a.size_-a.padding_))throw new Error('index out of range');try{return a.mask_[Math.floor(b/8)]&(1<<(b%8));}catch(c){throw c;}},any:function(a){var b=0;for(var c=0;c<a.size_;c++)b|=a.mask_[c];return(b!=0);},all:function(a){var b=true;var c=(a.size_==0)?0:a.size_-1;for(var d=0;d<c;d++)b=b&&(a.mask_[d]==0xff);return(b&&(a.mask_[c]==(0xff>>a.padding_)));},sum:function(a){var b=0;for(var c=0;c<a.size_;c++)for(var d=0;d<8;d++)if(a.mask_[c]&(1<<d))b++;return b;}};return function(b){var c={};c.length=(8*b.size_-b.padding_);for(var d in a)c[d]=partial(a[d],b);return c;};})();var d=function(d){a={};var e={buf:raw_helpers.decodeB64(d),index:0};e.data=new DataView(e.buf);var f="";for(var g=0;g<12;g++)f+=raw_helpers.zeroPad(b.uint8(e).toString(16),2);var h=f[4];var i=b.String(e);if(h==1)var j=b.float(e);var k=b.OMKeyMask(e);var l=b.ElementMasks(e);if(h==0&&l.length==0&&k.length==64&&k.all())k=c({size_:0,padding_:8,mask_:[0]});return{key_:i,omkey_mask_:k,element_masks_:l,masked_:null};};var e={Apply:function(a,b){if(a.masked_!=null)return a.masked_;if(!(a.key_ in b))throw new Error('key '+(a.key_)+' not in frame');var c=b[a.key_];if('Apply' in c)c=c.Apply(b);c.sort(function(a,b){if(a.string!=b.string)return a.string-b.string;else return a.om-b.om;});a.masked_=[];var d=0,e=0,f=0;for(;d<c.length;d++){if(!a.omkey_mask_.get(d))continue;else if(a.element_masks_[f].sum()==0){f++;continue;}var g=0;var h=[];var i=0;if(c[d].data.length!=a.element_masks_[f].length)throw new Error('The mask for OM('+(c[d].string)+','+(c[d].om)+') has '+(a.element_masks_[f].length)+' entries, but source has '+(c[d].data.length)+' entries');for(;i!=c[d].data.length;i++,g++)if(a.element_masks_[f].get(g))h.push(c[d].data[i]);f++;a.masked_.push({string:c[d].string,om:c[d].om,pmt:c[d].pmt,data:h});}return a.masked_;},GetSource:function(a){return a.key_;}};return function(a){try{var b=d(a);}catch(c){throw c;throw new Error("RecoPulseSeriesMapMask Error ("+c+")");}var f={};for(var g in e)f[g]=partial(e[g],b);return f;};})();RecoPulseSeriesMapUnion=(function(){"use strict";var a={};var b=jQuery.extend(raw_helpers.readers,{StringVector:function(c){b.header(c,'StringVector',a);var d=[];var e=b.uint32(c);for(var f=0;f<e;f++)d.push(b.String(c));return d;}});var c=function(c){a={};var d={buf:raw_helpers.decodeB64(c),index:0};d.data=new DataView(d.buf);var e="";for(var f=0;f<12;f++)e+=raw_helpers.zeroPad(b.uint8(d).toString(16),2);var g=e[4];var h=b.StringVector(d);return{keys_:h,unified_:null};};var d={Apply:function(a,b){if(a.unified_!=null)return a.unified_;var c=function(a){return(a.string)+','+(a.om)+','+(a.pmt);};a.unified_=[];for(var d=0;d<a.keys_.length;d++){if(!(a.keys_[d] in b))throw new Error('key '+a.keys_[d]+' not in frame');var e=b[a.keys_[d]];if('Apply' in e)e=e.Apply(b);e.sort(function(a,b){if(a.string!=b.string)return a.string-b.string;else return a.om-b.om;});var f={};var g=0,h='',i=null;for(;g<e.length;g++){h=c(e[g]);if(h in f){i=a.unified_[f[h]];for(var j=0;j<e[g].data.length;j++)i.data.push(e[g].data[j]);}else{f[h]=a.unified_.length;a.unified_.push(e[g]);}}}for(var j=0;j<a.unified_.length;j++)a.unified_[j].data.sort(function(a,b){return a.time-b.time;});a.unified_.sort(function(a,b){if(a.string!=b.string)return a.string-b.string;else return a.om-b.om;});return a.unified_;},GetSources:function(a){return a.keys_;}};return function(a){try{var b=c(a);}catch(e){throw e;throw new Error("RecoPulseSeriesMapUnion Error ("+e+")");}var f={};for(var g in d)f[g]=partial(d[g],b);return f;};})();var vector3d=function(){var a={x:0,y:0,z:0};var b={x:function(b){if(b!=null)a.x=b;else return a.x;},y:function(b){if(b!=null)a.y=b;else return a.y;},z:function(b){if(b!=null)a.z=b;else return a.z;},rho:function(c){if(c!=null){var d=b.phi();a.x=c*Math.cos(d);a.y=c*Math.sin(d);}else return Math.sqrt(a.x*a.x+a.y*a.y);},phi:function(c){if(c!=null){var d=b.rho();a.x=d*Math.cos(c);a.y=d*Math.sin(c);}else return Math.atan2(a.y,a.x);},r:function(c){if(c!=null){var d=b.theta();var e=b.phi();a.x=c*Math.cos(d)*Math.cos(e);a.y=c*Math.cos(d)*Math.sin(e);a.z=c*Math.sin(d);}else return Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z);},theta:function(c){var d=b.r();if(c!=null){var e=b.phi();a.x=d*Math.cos(c)*Math.cos(e);a.y=d*Math.cos(c)*Math.sin(e);a.z=d*Math.sin(c);}else if(d==0)return 0;else return Math.asin(a.z/b.r());}};return b;};var debug=false;var domain='';var log=logging('info');setDomain=function(a){domain=a;};viewerAjaxCaller=function(a,b,c,d){log.debug('ajaxCaller - url='+a);jQuery.ajax({url:a,dataType:'jsonp',data:b,cache:false}).fail(function(a,b,c){if(d!=undefined)d(b);else alert('error: '+b+'  - '+c);}).done(function(a,b,d){c(json_decode_helper(a));});};var VIEWER={REVISION:'4',Artists:{}};var viewer=function(a){var b={setup_renderer:function(d,e){var f=a(d.element).find('canvas').first();d.width=a(f).width();d.height=a(f).height();d.scene=new THREE.Scene();d.camera=new THREE.PerspectiveCamera(75,d.width/d.height,0.1,100000);d.scene.add(d.camera);d.camera.up=new THREE.Vector3(0,0,1);log.info('canvas width:'+d.width+' height:'+d.height);if(d.webgl===false||!Detector.webgl){if(!Detector.canvas)return false;try{d.renderer=new THREE.CanvasRenderer({canvas:f.get(0)});}catch(g){log.warn('cannot create canvas renderer');log.info(g);return false;}d.webgl=false;log.info('canvas renderer');}else{try{d.renderer=new THREE.WebGLRenderer({antialias:true,canvas:f.get(0),preserveDrawingBuffer:(d.allow_screenshot?true:false)});}catch(g){log.warn('cannot create webgl renderer');log.info(g);d.webgl=false;a(f).after('<canvas width="'+d.width+'" height="'+d.height+'">Sorry, this viewer requires a web browser which supports HTML5 canvas!</canvas>').remove();return b.setup_renderer(d,e);}if(d.renderer===undefined||!d.renderer.getContext()||d.renderer.capabilities===undefined||d.renderer.extensions===undefined||!d.renderer.extensions.get('EXT_frag_depth')){log.warn('webgl renderer not all there');d.webgl=false;a(f).after('<canvas width="'+d.width+'" height="'+d.height+'">Sorry, this viewer requires a web browser which supports HTML5 canvas!</canvas>').remove();return b.setup_renderer(d,e);}d.webgl=true;log.info('webgl renderer');}d.renderer.setPixelRatio(window.devicePixelRatio);d.renderer.setSize(d.width,d.height);if(d.high_contrast){d.renderer.setClearColor(0x111111,1);a(f).css('background-color','#111');}else{d.renderer.setClearColor(0x262626,1);a(f).css('background-color','#262626');}if(d.webgl==true)d.particlesphere_material=function(a){return new THREE.ShaderMaterial({uniforms:{},vertexShader:['attribute vec3 color;','attribute float size;','varying float radius;','varying vec3 vColor;','varying vec3 cameraSphereVertex;','void main()','{','    radius = size;','    vColor = color;','    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );','    gl_PointSize = size * ( 300.0 / length( mvPosition.xyz ) );','    gl_Position = projectionMatrix * mvPosition;','    cameraSphereVertex = vec3(mvPosition);','}'].join('\n'),fragmentShader:['uniform mat4 projectionMatrix;','varying float radius;','varying vec3 vColor;','varying vec3 cameraSphereVertex;','void main()','{','    if (radius <= 0.1) discard;','    vec4 tmp_color = vec4( vColor, 1.0 );','    vec2 coord = gl_PointCoord * 2.0 - 1.0;','    float lensq = dot( coord, coord );','    float len = sqrt(lensq);','    if (len > 1.0) discard;','    vec3 cameraNormal = vec3( coord, sqrt( 1.0-lensq ) );','    vec3 cameraPos = ( radius * cameraNormal )+ cameraSphereVertex;','#ifdef GL_EXT_frag_depth','    vec4 clipPos = projectionMatrix * vec4(cameraPos,1.0);','    float ndcDepth = clipPos.z / clipPos.w;','    gl_FragDepthEXT = ((gl_DepthRange.diff * ndcDepth) + gl_DepthRange.near + gl_DepthRange.far) * 0.5;','#endif','    vec3 light = vec3(0.0,0.0,0.0);','    vec3 n = cameraNormal;','    vec3 V = cameraPos;','    vec3 L = normalize( light-V );','    vec4 outcolor = vec4( 0.0, 0.0, 0.0, 1.0);','    vec4 Idiff = tmp_color * max(dot(n,L), 0.0);','    outcolor += clamp(Idiff, 0.0, 1.0);     ','    if (outcolor.a < 0.15) discard;','    if (length(outcolor.rgb) < 0.15) discard;','    gl_FragColor = vec4(outcolor.rgb, tmp_color.a);','}'].join('\n'),blending:THREE.CustomBlending,blendEquation:THREE.AddEquation,blendSrc:THREE.SrcAlphaFactor,blendSrcAlpha:THREE.OneFactor,blendDst:THREE.OneMinusSrcAlphaFactor,extensions:{fragDepth:true},depthTest:true,depthWrite:true,transparent:true});};else d.particlesphere_material=function(a){var b=Math.PI*2;var c=a.size*0.3;var d=a.color.clone();if(c<10){d.multiplyScalar(0.75);var e=decimalToHex(d.getHex());var f=function(a){a.beginPath();a.arc(0,0,c,0,b,true);a.fillStyle=e;a.fill();};}else{var e=decimalToHex(d.getHex());d.multiplyScalar(0.5);var g=decimalToHex(d.getHex());var h=-1*c;var i=2*c;var f=function(a){var b=a.createRadialGradient(0,0,0,0,0,c);b.addColorStop(0,e);b.addColorStop(0.2,e);b.addColorStop(0.95,g);b.addColorStop(1,'rgba(0,0,0,0)');a.fillStyle=b;a.fillRect(h,h,i,i);};}return new THREE.SpriteCanvasMaterial({color:d,program:f,depthTest:false,transparent:true});};if(e!=undefined){var h={};for(var i in c)h[i]=partial(c[i],d);setTimeout(function(){log.info('calling callback');e(h);},100);}},draw:function(a){a.camera.position.set(a.cameraPos.x()+a.centerPos.x(),a.cameraPos.y()+a.centerPos.y(),a.cameraPos.z()+a.centerPos.z());a.camera.lookAt(new THREE.Vector3(a.centerPos.x(),a.centerPos.y(),a.centerPos.z()));if(a.webgl!=true){if(a.high_contrast)a.renderer.setClearColor(0x111111,1);else a.renderer.setClearColor(0x262626,1);a.renderer.clear();}try{var b=Date.now();a.renderer.render(a.scene,a.camera);if(a.webgl!=true&&Date.now()-b<10){log.warn('canvas_full = false');a.canvas_full=false;}}catch(c){log.error('render error '+c+' '+c.fileName+' '+c.lineNumber);}},rotate_viewer:function(a,b,c){a.cameraPos.phi(a.cameraPos.phi()+b/a.width*Math.PI*2.0);var d=a.cameraPos.theta()-c/a.height*Math.PI;if(d>Math.PI/2)d=Math.PI/2;else if(d<-1*Math.PI/2)d=-1*Math.PI/2;a.cameraPos.theta(d);},translate_viewer:function(a,b,c){b*=2;c*=2;var d=a.cameraPos.r();var e=a.cameraPos.phi();var f=a.cameraPos.theta();var g=Math.sqrt(b*b+c*c+d*d);var h=Math.atan(b/d);var i=-1*Math.atan(c/d);var j=new vector3d();j.r(g);j.phi(e+h);j.theta(f+i);var k=j.x()-a.cameraPos.x();var l=j.y()-a.cameraPos.y();var m=j.z()-a.cameraPos.z();a.centerPos.x(a.centerPos.x()+k);a.centerPos.y(a.centerPos.y()+l);a.centerPos.z(a.centerPos.z()+m);},add_strings:function(a){var b=a.geometry;if(b==undefined){log.error('no geometry loaded. cannot draw strings');return;}var c=0;for(var d in b)for(var e in b[d])for(var f in b[d][e])c+=1;console.log('nPMTs: '+c);var g=new Float32Array(c*3);var h=new Float32Array(c*3);var i=new Float32Array(c);var j=null;if(a.string_lines!=null&&a.string_lines!=undefined){for(var k=a.string_lines.length-1;k>=0;k--)a.scene.remove(a.string_lines[k]);delete a.string_lines;}a.string_lines=[];log.info('show_fiducial:'+a.show_fiducial);var l=0;for(var d in b){var m=b[d];var n=0;var o=null;var p=null;for(var e in m){var q=m[e];for(var f in q){var r=q[f];var s=r.pos;var t=new THREE.Color(0xC3C3C3);var u=5;if(r.type==1){if(o==null||o.z<s.z)o=s;if(p==null||p.z>s.z)p=s;if(a.show_fiducial&&!(r.fiducial===true)){n+=1;t=new THREE.Color(0xFF1CDE);u=7;}else if(a.webgl==false&&a.canvas_full==false)u=0;}else if(r.type==2){t=new THREE.Color(0xFCFCFC);u=8;}var v=l*3;g[v]=s.x;g[v+1]=s.y;g[v+2]=s.z;h[v]=t.r;h[v+1]=t.g;h[v+2]=t.b;i[l]=u;l+=1;}}var w=new THREE.Geometry();if(o!=null&&p!=null){w.vertices.push(new THREE.Vector3(o.x,o.y,o.z));w.vertices.push(new THREE.Vector3(p.x,p.y,p.z));}if(w.vertices.length>0){if(a.webgl==true)var x=new THREE.Line(w,new THREE.LineBasicMaterial({color:0x606060,linewidth:1,opacity:0.8,transparent:true}));else{var t=(n>15&&a.canvas_full!=true)?0xFF1CDE:0x909090;var x=new THREE.Line(w,new THREE.LineBasicMaterial({color:t,linewidth:0.4,opacity:1,blending:THREE.AdditiveBlending,transparent:true}));}a.string_lines.push(x);a.scene.add(x);}}if(a.pmtSystem!=null&&a.pmtSystem!=undefined){a.scene.remove(a.pmtSystem);delete a.pmtSystem;}if(a.webgl==true){var y=function(){this.array=null;};var b=new THREE.BufferGeometry();b.addAttribute('position',new THREE.BufferAttribute(g,3).onUpload(y));b.addAttribute('color',new THREE.BufferAttribute(h,3).onUpload(y));b.addAttribute('size',new THREE.BufferAttribute(i,1).onUpload(y));a.pmtSystem=new THREE.Points(b,a.particlesphere_material({}));}else{a.pmtSystem=new THREE.Group();var z=null;var A=null;for(var k=0;k<c;k++){if(i[k]<1)continue;var B=k*3;A={size:i[k],color:new THREE.Color(h[B],h[B+1],h[B+2])};z=new THREE.Sprite(a.particlesphere_material(A));z.position.set(g[B],g[B+1],g[B+2]);a.pmtSystem.add(z);}}a.scene.add(a.pmtSystem);},add_recopulses:function(a){if(a.frameno>=a.maxframes||!(a.pulseseries in a.frames[a.frameno])){log.warn('no frames or no pulseseries to show');log.info('state.frameno: '+a.frameno);log.info('state.maxframes: '+a.maxframes);log.info('state.frames.length: '+a.frames.length);return;}var b=a.frames[a.frameno][a.pulseseries];var c=a.current_time;log.info('add_recopulses');log.debug('start time: '+a.begin);log.debug('end time: '+a.end);log.debug('finaltime: '+c);var d=b.length;console.log('nHits: '+d);var e=new Float32Array(d*3);var f=new Float32Array(d*3);var g=new Float32Array(d);for(var h=0;h<d;h++){var i=b[h].pmt;var j=b[h].om;var k=b[h].string;var l=0;var m=0;for(var n=0;n<b[h].data.length;n++){if(l==0)l=b[h].data[n].time;if(b[h].data[n].time>c)continue;m+=b[h].data[n].charge;}try{var o=a.geometry[k][j][i].pos;}catch(p){log.warn('bad string '+k+'  om '+j);}log.debug('pos '+JSON.stringify(o));var q=h*3;e[q]=o.x;e[q+1]=o.y;e[q+2]=o.z;var r=new THREE.Color(0x0000FF);var s=0;if(l>a.color_end)s=1;else if(l>a.color_begin)s=(l-a.color_begin)/(a.color_end-a.color_begin);if(a.high_contrast)r.setHSL(s*0.6666,1,0.5);else r.setHSL(s*0.6666,1,0.5);f[q]=r.r;f[q+1]=r.g;f[q+2]=r.b;if(m<=0)g[h]=0;else{var t=Math.log(m*10)/Math.LN10*25;if(t<1)t=1;g[h]=t;}}if(a.hitSystem!=null&&a.hitSystem!=undefined){a.scene.remove(a.hitSystem);delete a.hitSystem;}if(a.webgl==true){var u=new THREE.BufferGeometry();var v=function(){this.array=null;};u.addAttribute('position',new THREE.BufferAttribute(e,3).onUpload(v));u.addAttribute('color',new THREE.BufferAttribute(f,3).onUpload(v));u.addAttribute('size',new THREE.BufferAttribute(g,1).onUpload(v));a.hitSystem=new THREE.Points(u,a.particlesphere_material({}));}else{a.hitSystem=new THREE.Group();var w=null;var x=null;for(var n=0;n<d;n++){var q=n*3;x={size:g[n],color:new THREE.Color(f[q],f[q+1],f[q+2])};w=new THREE.Sprite(a.particlesphere_material(x));w.position.set(e[q],e[q+1],e[q+2]);a.hitSystem.add(w);}}a.scene.add(a.hitSystem);},add_linefit:function(a,b){var c=new THREE.Geometry();var d=a.current_time;log.debug('add LineFit');var e=b.pos;var f=b.dir;var g=b.time;var h=b.speed;var i=vector3d();log.debug('speed:'+h+' begin:'+a.begin+' time:'+g+' curtime:'+d);i.x(f.x);i.y(f.y);i.z(f.z);i.r(h*(a.begin-g));var j={x:(e.x+i.x()),y:(e.y+i.y()),z:(e.z+i.z())};i.x(f.x);i.y(f.y);i.z(f.z);i.r(h*(d-g));var k={x:(e.x+i.x()),y:(e.y+i.y()),z:(e.z+i.z())};log.debug('pos:'+JSON.stringify(e)+' neg:'+JSON.stringify(j)+' pos:'+JSON.stringify(k));c.vertices.push(new THREE.Vector3(j.x,j.y,j.z));c.vertices.push(new THREE.Vector3(k.x,k.y,k.z));if(a.linefit!=null&&a.linefit!=undefined){a.scene.remove(a.linefit);delete a.linefit;}a.linefit=new THREE.Line(c,new THREE.LineBasicMaterial({color:0xff0000,linewidth:2}));a.scene.add(a.linefit);},compress_recopulses:function(a){var b=a.frames[a.frameno][a.pulseseries];log.info('compress_recopulses');log.debug('start time: '+a.begin);log.debug('end time: '+a.end);for(var c=0;c<b.length;c++){if(b[c].data.length<1)continue;var d=-1;var e=0;for(var f=0;f<b[c].data.length;f++){if(d==-1||b[c].data[f].time<d)d=b[c].data[f].time;e+=b[c].data[f].charge;}if(e<=0)b[c].data=[];b[c].data=[{time:d,charge:e}];}},make_charge_hist:function(b){if(b.frameno>=b.maxframes||!(b.pulseseries in b.frames[b.frameno]))return;var c=b.frames[b.frameno];var d=100;var e=800;if(!b.raw_viewer){var f=a(b.element).find('div.charge_hist').first();var d=a(f).height();var e=a(f).width()-1;}var g=[];var h=[[],[]];for(var i=0;i<e;i++){g[i]=0;h[0][i]=0;h[1][i]=0;}var j=0;var k=null;for(var l=0;l<c[b.pulseseries].length;l++){k=c[b.pulseseries][l];var m=[];var n=0;for(var i=0;i<e;i++)m[i]=0;for(var i=0;i<k.data.length;i++){if(k.data[i].charge<=0)continue;var o=0;if(k.data[i].time>=b.end)o=e-1;else if(k.data[i].time>b.begin)o=Math.floor((k.data[i].time-b.begin)/(b.end-b.begin)*e);g[o]+=k.data[i].charge;m[o]+=k.data[i].charge;j+=k.data[i].charge;n+=k.data[i].charge;}var p=0,q=0,r=-1;var s=[];for(var i=0;i<e;i++){if(r==-1&&m[i]>0)r=i;for(var t=0;t<m[i];t++){s.push(i);p+=i;q+=1;}}p=mode(s);h[0][r]+=n;h[1][p]+=n;}k=null;if(!b.force_color_times&&b.smart_color){var u=[[],[]],v=Math.floor(e/10);for(var i=0;i<v;i++){u[0][i]=0;u[1][i]=0;}for(var i=0;i<e;i++){u[0][Math.floor(i/10)]+=h[0][i];u[1][Math.floor(i/10)]+=h[1][i];}var w=-1;var x=0;var y=Math.log(j)/Math.log(10);var z=0.1;if(b.webgl!=true&&b.canvas_full!=true){y=Math.log(j*5)/Math.log(10);z=0.01;}for(var i=0;i<h[0].length;i++){if(u[0][Math.floor(i/10)]*v/j>z)if(Math.log(j/h[0][i])/Math.log(10)<y)x=i;if(w==-1&&u[1][Math.floor(i/10)]*v/j>0.05)if(Math.log(j/h[1][i])/Math.log(10)<Math.log(j)/Math.log(10)*0.9)w=i;}if(w<0)w=0;console.log('low: '+w+'  high: '+x);var A=1.5,B=1.5;if(b.webgl!=true&&b.canvas_full!=true)B=5.5;var C=[];for(var i=0;i<e;i++)for(var t=0;t<g[i];t++)C.push(i);var D=average(C);var E=D.mean-(A*D.deviation),F=D.mean+(B*D.deviation);if(!isNaN(E)&&E>w)w=E;if(!isNaN(F)&&F<x)x=F;console.log('stddev low: '+E+'  high: '+F);if(w<=0)b.color_begin=b.begin;else b.color_begin=Math.floor(w/e*(b.end-b.begin)+b.begin);if(x>=e-1)b.color_end=b.end;else b.color_end=Math.floor(x/e*(b.end-b.begin)+b.begin);}if(b.raw_viewer)return;var G='';for(var i=0;i<e;i++){var H=0;if(g[i]>0&&g[i]<=1)H=1;else if(g[i]>1){var I=Math.pow(g[i],.25);H=Math.ceil((d*I-(d-1))/I);}G+='<div class="hist_data" style="height:'+H+'px"></div>';}G+='<div class="hist_data filler"></div>';a(f).html(G);},make_colorline:function(b){if(b.raw_viewer)return;var c=a(b.element).find('div.timeline div.colorline').first();var d=a(c).width()-1;var e=Math.floor((b.color_begin-b.begin)/(b.end-b.begin)*d);var f=Math.floor((b.color_end-b.begin)/(b.end-b.begin)*d);var g='';var h=1;var i=b.high_contrast;var j=1/(f-e)*0.6666;var k=(i?'#FF0000':'#FF7F7F');var l=undefined,m=new THREE.Color();for(var n=1;n<=d;n++){if(i)if(n<e)l='#FF0000';else if(n<f){m.setHSL((n-e)*j,1,0.5);l=decimalToHex(m.getHex());}else l='#0000FF';else if(n<e)l='#FF7F7F';else if(n<f){m.setHSL((n-e)*j,1,0.75);l=decimalToHex(m.getHex());}else l='#7F7FFF';if(k==l)h+=1;else{g+='<div class="color_data" style="background-color:'+k+';width:'+h+'px"></div>';h=1;k=l;}}g+='<div class="color_data" style="background-color:'+k+';width:'+h+'px"></div>';a(c).html(g);},make_controls:function(c){if(c.raw_viewer)return;var d=a(c.element).find('div.timeline div.controls').first();a(d).off();var e=a('body');var f=a(d).width()-1;log.info('maxwidth:'+f);var g=Math.floor((c.color_begin-c.begin)/(c.end-c.begin)*f);var h=Math.floor((c.color_end-c.begin)/(c.end-c.begin)*f);console.log('firstbin: '+g+'  lastbin: '+h);var i=Math.floor((c.current_time-c.begin)/(c.end-c.begin)*f);var j='<div class="time_marker" style="left:'+i+'px"><div class="inner_time_marker"></div></div>';if(c.high_contrast){j+='<div class="color_marker begin_color" ';j+='style="background-color:#ff0000;left:'+g+'px"></div>';j+='<div class="color_marker end_color" ';j+='style="background-color:#0000ff;left:'+h+'px"></div>';}else{j+='<div class="color_marker begin_color" ';j+='style="background-color:#ff7f7f;left:'+g+'px"></div>';j+='<div class="color_marker end_color" ';j+='style="background-color:#7f7fff;left:'+h+'px"></div>';}a(d).html(j);var k=Math.floor(a(d).find('div.color_marker').first().width()/3)*-1;var l=Math.floor(f+k*2);var m=a(d).find('div.begin_color');var n=a(d).find('div.end_color');a(m).css('left',g+k);a(n).css('left',h+k*2);log.info('min_pos:'+k);log.info('max_pos:'+l);var o=(function(){var g=a(d).find('div.time_marker');var h=a(g).width()/2;var i=false;var j=a(g).position().left;var k=undefined;var l=f/20;var m=Math.floor(a(g).width()/2-1)*-1;var n=Math.floor(f+m-1);var o={reset_to_state:function(){var b=Math.floor((c.current_time-c.begin)/(c.end-c.begin)*f-h);a(g).css('left',b);},to_cur_pos:function(d,e){e.stopPropagation();var i=e.pageX-a(g).offset().left-h;marker_pos_left=a(g).position().left;if(i>0)if(marker_pos_left+i<n)a(g).css('left',marker_pos_left+i);else if(marker_pos_left!=n)a(g).css('left',n);else return;else if(marker_pos_left+i>=m)a(g).css('left',marker_pos_left+i);else if(marker_pos_left!=m)a(g).css('left',m);else return;marker_pos_left=a(g).position().left;c.current_time=Math.floor((marker_pos_left+h)/f*(c.end-c.begin)+c.begin);if((!d)||j-marker_pos_left>l||j-marker_pos_left<-1*l){if(k!=undefined){clearTimeout(k);k=undefined;}j=marker_pos_left;b.add_recopulses(c);b.display_artists(c);b.draw(c);}else if(k==undefined)k=setTimeout(function(){b.add_recopulses(c);b.display_artists(c);b.draw(c);j=marker_pos_left;k=undefined;},250);},attach:function(f){f.stopPropagation();a(d).addClass('active');a(e).on('mousemove vmousemove touchmove',function(a){if(a.type=='touchmove'){a.pageX=a.originalEvent.touches[0].pageX;a.pageY=a.originalEvent.touches[0].pageY;a.originalEvent.preventDefault();}if(i==true)return;i=true;o.to_cur_pos(true,a);i=false;});a(e).on('mouseup mouseleave mousecancel vmouseup vmousecancel touchend touchcancel',function(){if(f.type=='touchend'||f.type=='touchcancel')f.originalEvent.preventDefault();a(e).off('mousemove mouseup mouseleave mousecancel vmousemove vmouseup vmousecancel touchmove touchend touchcancel');a(d).removeClass('active');if(k!=undefined){clearTimeout(k);k=undefined;pos_last_draw=a(g).position().left;b.add_recopulses(c);b.display_artists(c);b.draw(c);}});}};return o;})();o.reset_to_state();a(d).find('div.time_marker').on('mousedown vmousedown touchstart',o.attach);a(d).on('mousedown vmousedown touchstart',function(a){a.stopImmediatePropagation();if(a.type=='touchstart'){a.pageX=a.originalEvent.touches[0].pageX;a.pageY=a.originalEvent.touches[0].pageY;a.originalEvent.preventDefault();}o.to_cur_pos(false,a);o.attach(a);});a(d).find('div.color_marker').each(function(){var g=this;a(g).on('mousedown vmousedown touchstart',function(h){h.stopPropagation();if(h.type=='touchstart'){h.pageX=h.originalEvent.touches[0].pageX;h.pageY=h.originalEvent.touches[0].pageY;h.originalEvent.preventDefault();}a(d).addClass('active');var i=a(g).hasClass('begin_color');var j=false;var o=a(g).width()/2;var p=a(g).position().left;var q=undefined;var r=f/20;a(e).on('mousemove vmousemove touchmove',function(d){if(d.type=='touchmove'){d.pageX=d.originalEvent.touches[0].pageX;d.pageY=d.originalEvent.touches[0].pageY;d.originalEvent.preventDefault();}if(j==true)return;j=true;var e=d.pageX-a(g).offset().left-o;if(e>-2&&e<2){j=false;return;}var h=a(g).position().left;if(e>0){var s=l;if(i)s=a(n).position().left-o;if(h+e<=s)a(g).css('left',h+e);else if(h!=s)a(g).css('left',s);else{j=false;return;}}else{var t=k;if(!i)t=a(m).position().left+o;if(h+e>=t)a(g).css('left',h+e);else if(h!=t)a(g).css('left',t);else{j=false;return;}}h=a(g).position().left;var u=Math.floor((h+o)/f*(c.end-c.begin)+c.begin);if(i)c.color_begin=u;else c.color_end=u;b.make_colorline(c);if(p-h>r||p-h<-1*r){if(q!=undefined){clearTimeout(q);q=undefined;}b.add_recopulses(c);b.display_artists(c);b.draw(c);p=h;}else if(q==undefined)q=setTimeout(function(){b.add_recopulses(c);b.display_artists(c);b.draw(c);p=h;q=undefined;},250);j=false;});a(e).on('mouseup mouseleave mousecancel vmouseup vmousecancel touchend touchcancel',function(){if(h.type=='touchend'||h.type=='touchcancel')h.originalEvent.preventDefault();a(e).off('mousemove mouseup mouseleave mousecancel vmousemove vmouseup vmousecancel touchmove touchend touchcancel');a(d).removeClass('active');if(q!=undefined){clearTimeout(q);q=undefined;b.add_recopulses(c);b.display_artists(c);b.draw(c);}});});});},update_controls:function(b){if(b.raw_viewer)return;var c=a(b.element).find('div.timeline div.controls').first();var d=a(c).find('div.time_marker');var e=a(c).width()-1;var f=a(d).width()/2;var g=Math.floor(a(d).width()/2-2)*-1+f;var h=Math.floor(e+g)-f;var i=Math.floor((b.current_time-b.begin)/(b.end-b.begin)*e-f);if(i>=h)i=h;else if(i<g)i=g;a(d).css('left',i);},make_timeline:function(c){if(!c.raw_viewer){var d=a(c.element).find('div.timeline div.left_col').first();var e='<div class="pulse_choose';if(c.pulse_choose){e+='"><select>';var f=b.find_all_pulseseries(c);log.info('pulseseries_list: '+JSON.stringify(f));for(var g=0;g<f.length;g++){e+='<option value="'+f[g]+'"';if(f[g]==c.pulseseries)e+=' selected';e+='>'+f[g]+'</option>';}e+='</select>';}else e+=' disabled">';e+='</div><div class="color_text">Color mapping:</div>';a(d).html(e);if(c.pulse_choose)a(d).find('div.pulse_choose select').on('change',function(){c.pulseseries=this.value;b.display_frame(c);});var h=a(c.element).find('div.timeline').width()-a(d).width()-3;log.info('center col width set to '+h);a(c.element).find('div.timeline div.center_col').css('width',h);a(c.element).find('div.timeline div.center_col div').css('width',h);}b.make_charge_hist(c);if(!c.raw_viewer){b.make_colorline(c);b.make_controls(c);}},update_timeline:function(a){b.update_controls(a);},display_artists:function(a){for(var b in a.active_artists)try{VIEWER.Artists[b](a,a.active_artists[b]);}catch(c){log.warn('artist '+b+' failed');log.warn(c);}},mouse_move:function(a,c){if(c.type=='touchmove'){c.pageX=c.originalEvent.touches[0].pageX;c.pageY=c.originalEvent.touches[0].pageY;c.originalEvent.preventDefault();if(c.originalEvent.touches.length==2){b.zoom(a,c);return;}}if(a.isdrawing==true)return;a.isdrawing=true;var d=c.pageX;var e=c.pageY;if(a.prev_mouse_pos.x!=null){var f=a.prev_mouse_pos.x-d;var g=a.prev_mouse_pos.y-e;if(a.shiftkey==true||(c.type=='touchmove'&&c.originalEvent.touches.length>2))b.translate_viewer(a,f,g);else b.rotate_viewer(a,f,g);b.draw(a);}a.prev_mouse_pos.x=d;a.prev_mouse_pos.y=e;a.isdrawing=false;},touch_distance:function(a){return Math.sqrt(Math.pow(a.originalEvent.touches[0].pageX-a.originalEvent.touches[1].pageX,2)+Math.pow(a.originalEvent.touches[0].pageY-a.originalEvent.touches[1].pageY,2));},zoom:function(a,c,d){if(d==undefined&&c.type=='touchmove'&&c.originalEvent.touches.length==2){if(a.zoom_touches==undefined){a.zoom_touches=b.touch_distance(c);return;}d=0.1*(b.touch_distance(c)-a.zoom_touches);if(Math.abs(d)<0.1)return;}if(a.isdrawing==true&&c.type!='touchmove'){a.zoom_delta+=d;return;}isdrawing=true;d+=a.zoom_delta;a.zoom_delta=0;a.zoom_touches=undefined;var e=a.cameraPos.r()-d*100;if(e<0.1)e=0.1;a.cameraPos.r(e);b.draw(a);a.isdrawing=false;},display_info:function(d){if(d.raw_viewer)return;var e='';if(d.navigation==true){e='<div class="navigation" style="text-align:center;width:'+d.width+'px">';e+='<button class="prev_frame" style="float:left">&lt;</button>';e+='<button class="next_frame" style="float:right">&gt;</button>';e+=d.frameno;e+='</div>';}if(true){e+='<div class="movie_control" style="text-align:center;width:'+d.width+'px">';e+='<button class="play_pause">';if(d.playing==true)e+='Pause';else e+='Play';e+='</button><button class="stop">';e+='Stop and Reset</button></div>';}a(d.element).find('.fileinfo').html(e);if(true)var f=d.playing;if(d.frameno<=0)a(d.element).find('.fileinfo button.prev_frame').attr("disabled",true);else a(d.element).find('.fileinfo button.prev_frame').on('click',function(){d.frameno-=1;b.display_frame(d);});if(d.frameno+1>=d.maxframes)a(d.element).find('.fileinfo button.next_frame').attr("disabled",true);else a(d.element).find('.fileinfo button.next_frame').on('click',function(){d.frameno+=1;b.display_frame(d);});a(d.element).find('.fileinfo button.play_pause').on('click',function(){if(d.playing==true)c.pause(d);else c.play(d);});a(d.element).find('.fileinfo button.stop').on('click',partial(c.stop,d));},display_frame:function(a){log.info('display_frame()');var c=-1,d=-1;if(a.frames==undefined){log.warn('state.frames is undefined');return;}if(a.pulseseries==''||!(a.pulseseries in a.frames[a.frameno])){log.warn('pulseseries ('+a.pulseseries+') not in frame');return;}b.getpulses(a,a.pulseseries);if(a.webgl!=true&&a.canvas_full!=true)b.compress_recopulses(a);var e=a.frames[a.frameno][a.pulseseries];for(var f in e){if(e[f].data.length<1)continue;var g=e[f].data[0].time;var h=e[f].data[e[f].data.length-1].time;if(c==-1){c=g;d=h;}else{if(g<c)c=g;if(h>d)d=h;}}a.begin=c;a.end=d;if(!a.force_color_times){console.log('resetting color times');a.color_begin=c;a.color_end=d;}else console.log('color times set manually: '+a.color_begin+' - '+a.color_end);if(a.playing==true)a.current_time=c;else a.current_time=d;log.warn('display_frame() current_time:'+a.current_time);b.make_timeline(a);b.update_frame(a);b.display_info(a);log.debug('display_frame() end');},update_frame:function(a){var c,d;b.add_recopulses(a);if(a.bestfit_line&&'LineFit' in a.frames[a.frameno])b.add_linefit(a,a.frames[a.frameno].LineFit);else if(a.linefit!=null&&a.linefit!=undefined){a.scene.remove(a.linefit);delete a.linefit;}b.update_timeline(a);b.display_artists(a);b.draw(a);},handle_keydown:function(a,c){var d=(c.which)?c.which:c.keyCode;if(d==16)a.shiftkey=true;else{var e=0,f=0;if(d==37)e-=10;else if(d==38)f+=10;else if(d==39)e+=10;else if(d==40)f-=10;else if(d==107)b.zoom(a,c,1);else if(d==109)b.zoom(a,c,-1);else if(d==187)b.zoom(a,c,1);else if(d==189)b.zoom(a,c,-1);if(e!=0||f!=0)if(a.shiftkey==true)b.translate_viewer(a,e,f);else b.rotate_viewer(a,e,f);b.draw(a);}return false;},handle_keyup:function(a,b){var c=(b.which)?b.which:b.keyCode;if(c==16)a.shiftkey=false;return false;},find_all_pulseseries:function(b){var c=[];for(var d in b.frames[b.frameno]){var e=b.frames[b.frameno][d];try{if((a.type(e)=='array'&&'data' in e[0])||(a.type(e)=='object'&&('Apply' in e||'sources' in e||('source' in e&&'mask' in e&&'elements' in e))))c.push(d);}catch(f){continue;}}return c.sort();},getpulses:function(a,c){try{var d=a.frames[a.frameno];if(c in d){var e=d[c];if('Apply' in e)d[c]=e.Apply(d);else if('source' in e&&'mask' in e&&'elements' in e){if(e.source in d){b.getpulses(a,e.source);var f=d[e.source];var g=[];var h=e.mask;var i=e.elements;var j=0;log.debug('source length: '+f.length);log.debug('mask length: '+h.length);var k=0;for(;k<f.length;k++){if(!h.isset(k))continue;else if(i[j].sum()==0){console.warn('element sum = 0 for m='+k+' and element_index='+j);j++;continue;}var l={om:f[k].om,pmt:f[k].pmt,string:f[k].string,data:[]};if(f[k].data.length!=i[j].length)throw new Error('The mask for OM('+(f[k].om)+','+(f[k].pmt)+' has '+(i[j].length)+' entries, but source pulse vector has '+(f[k].data.length)+' entries!');for(var m=0;m<i[j].length;m++){if(m>=f[k].data.length)throw new Error('more element bits in mask than in source for m='+k);if(i[j].isset(m))l.data.push(f[k].data[m]);}j++;g.push(l);}log.debug('element length: '+i.length);log.debug('elements used: '+j);log.debug('last index: '+k);d[c]=g;}}else if('sources' in e){var n=[];for(var o=0;o<e.sources.length;o++){var f=e.sources[o];if(f in d){b.getpulses(a,f);for(var p=0;p<d[f].length;p++)n.push(d[f][p]);}}d[c]=n;}}}catch(m){throw m;log.warn('error getting pulses for key '+c+'  '+m+' line:'+m.lineNumber);}}};var c={load_gcd:function(a,c,d){log.debug('load_gcd '+JSON.stringify(c));a.downloader({'function':'getGCD','gcd_filename':c},function(c){a.geometry=c.data;var e=a.canvas_full;b.add_strings(a);b.draw(a);if(e==true&&a.webgl!=true&&a.canvas_full!=true){b.add_strings(a);b.draw(a);}if(d!=undefined)d();});},load_data:function(a,c,d,e){log.debug('load_data '+c);if(d==undefined)d='P';a.downloader({'function':'getI3','i3_filename':c,'frame_type':d},function(c){a.frames=c.data;a.frameno=0;a.maxframes=0;for(var d=0;d<a.frames.length;d++)a.maxframes++;log.info('maxframes:'+a.maxframes);a.pulseseries='';if(a.maxframes>0)for(var f=0;f<a.preferred_pulseseries.length;f++){var g=a.preferred_pulseseries[f];if(g in a.frames[0]){a.pulseseries=g;break;}}log.info('pulseseries:'+a.pulseseries);b.display_frame(a);if(e!=undefined)e();});},set_gcd_data:function(a,c,d){a.geometry=c;var e=a.canvas_full;b.add_strings(a);b.draw(a);if(e==true&&a.webgl!=true&&a.canvas_full!=true){b.add_strings(a);b.draw(a);}a.frames=d;a.frameno=0;a.maxframes=0;for(var f=0;f<a.frames.length;f++)a.maxframes++;log.info('maxframes:'+a.maxframes);a.pulseseries='';if(a.maxframes>0)for(var g=0;g<a.preferred_pulseseries.length;g++){var h=a.preferred_pulseseries[g];if(h in a.frames[0]){a.pulseseries=h;break;}}log.info('pulseseries:'+a.pulseseries);b.display_frame(a);},set_center:function(a,c,d,e){a.centerPos.x(c);a.centerPos.y(d);a.centerPos.z(e);b.draw(a);},set_camera:function(a,b,c,d){a.cameraPos=vector3d();a.cameraPos.x(b);a.cameraPos.y(c);a.cameraPos.z(d);},set_navigation:function(a,c){a.navigation=!!c;b.display_frame(a);},set_fiducial:function(a,c){a.show_fiducial=!!c;b.add_strings(a);b.update_frame(a);},play:function(c){var d=150;var e=67;var f=1000;if(c.webgl!=true&&c.canvas_full!=true){d=30;e=333;}if(c.playing==false){c.playing=true;c.animation_timer=setTimeout(function g(){if(c.current_time>=c.end)c.current_time=c.begin;else{c.current_time+=(c.end-c.begin)/d;if(c.current_time>c.end)c.current_time=c.end;}b.update_frame(c);if(c.current_time>=c.end)c.animation_timer=setTimeout(g,f);else c.animation_timer=setTimeout(g,e);},e);if(!c.raw_viewer)a(c.element).find('.fileinfo button.play_pause').text('Pause');}},pause:function(b){if(b.playing==true){b.playing=false;clearTimeout(b.animation_timer);if(!b.raw_viewer)a(b.element).find('.fileinfo button.play_pause').text('Play');}},stop:function(c){if(c.playing==true){c.playing=false;clearTimeout(c.animation_timer);if(!c.raw_viewer)a(c.element).find('.fileinfo button.play_pause').text('Play');}c.current_time=c.end;b.update_frame(c);b.draw(c);},take_screenshot:function(a,b){if(!a.allow_screenshot)return;if(b==undefined)b='image/png';return a.renderer.domElement.toDataURL(b);},replace_with_image:function(c,d){if(!c.allow_screenshot)return false;var e='image/png';var f=c.renderer.domElement.toDataURL(e);if(f){var g={canvas:a(c.element).find('canvas').first()};var h=a(g.canvas).width();var i=a(g.canvas).height();delete c.renderer;var j=document.createElement('img');j.src=f;j.width=h;j.height=i;if(c.high_contrast)a(j).css('background-color','#111');else a(j).css('background-color','#262626');a(g.canvas).unmousewheel();a(g.canvas).off().replaceWith(j);delete g.canvas;a(document).off('keydown keyup');console.warn('canvas is petrified');a(c.element).find('div.drawing img').first().on('mousedown vmousedown',function(e){e.stopPropagation();e.preventDefault();a(this).off('mousedown vmousedown');var f=this;a(this).after('<canvas width="'+h+'" height="'+i+'" style="position:absolute;left:-'+(a(document).width()+h*2)+'px"></canvas>');var g=a(c.element).find('canvas').first();a(g).on('mousedown vmousedown touchstart',function(d){if(d.type=='touchstart'){d.originalEvent.preventDefault();if(d.originalEvent.touches.length>1){if(d.originalEvent.touches.length==2&&c.zoom_touches==undefined)c.zoom_touches=b.touch_distance(event);return true;}}a(g).on('mousemove vmousemove touchmove',partial(b.mouse_move,c));});function j(b){a(g).off('mousemove vmousemove touchmove');c.isdrawing=false;c.zoom_touches=undefined;c.prev_mouse_pos.x=null;c.prev_mouse_pos.x=null;}a(g).on('mouseup vmouseup touchend touchcancel',j);a(g).on('mouseout vmouseout touchleave',j);a(g).mousewheel(partial(b.zoom,c),true);a(document).keydown(partial(b.handle_keydown,c));a(document).keyup(partial(b.handle_keyup,c));b.setup_renderer(c,function(){b.add_strings(c);b.update_frame(c);a(f).remove();a(g).css({position:'relative',left:0});log.warn('canvas is restored');a(g).trigger('mousedown vmousedown');if(d)d.apply(g);});});return true;}return false;}};var d=function(c,d){c=a.extend({domain:'',element:a(document),webgl:false,navigation:false,raw_viewer:false,show_fiducial:false,high_contrast:false,playing:false,isdrawing:false,prev_mouse_pos:{x:null,y:null},shiftkey:false,allow_screenshot:false,zoom_delta:0,pulse_choose:true,preferred_pulseseries:['OfflinePulses','InIcePulses','OfflinePulseSeriesReco','IceTopPulses'],bestfit_line:true,smart_color:false,force_color_times:false,color_begin:0,color_end:3000,active_artists:{'accumulated_charge_counter':true},downloader:undefined,webgl:undefined,canvas_full:true},c);c.downloader=partial(viewerAjaxCaller,c.domain+'/ajax');log.info(c.preferred_pulseseries);var e=a(c.element).innerWidth();var f=a(c.element).innerHeight();var g=f;if(!c.raw_viewer)g-=110;var h='<div class="drawing"><canvas width="'+e+'" height="'+g+'">Sorry, this viewer requires';h+=' a web browser which supports HTML5 canvas!</canvas>';if(!c.raw_viewer){h+='<div class="timeline" style="width:'+e+'px">';h+='<div class="left_col"></div><div class="center_col">';h+='<div class="controls"></div><div class="charge_hist"></div>';h+='<div class="colorline"></div></div></div>';h+='</div><div class="fileinfo"></div><div class="frames" style="display:none">';}h+='</div>';a(c.element).html(h);var i=a(c.element).find('canvas').first();log.debug('canvas : '+JSON.stringify(i.length));c.width=a(i).width();c.height=a(i).height();c.frameno=0;log.debug('canvas width:'+c.width+' height:'+c.height);b.setup_renderer(c,d);c.centerPos=vector3d();c.centerPos.z(800);c.cameraPos=vector3d();c.cameraPos.rho(2000);c.cameraPos.z(1450);a(i).on('mousedown vmousedown touchstart',function(d){if(d.type=='touchstart'){d.originalEvent.preventDefault();if(d.originalEvent.touches.length>1){if(d.originalEvent.touches.length==2&&c.zoom_touches==undefined)c.zoom_touches=b.touch_distance(event);return true;}}a(i).on('mousemove vmousemove touchmove',partial(b.mouse_move,c));});function j(b){a(i).off('mousemove vmousemove touchmove');c.isdrawing=false;c.zoom_touches=undefined;c.prev_mouse_pos.x=null;c.prev_mouse_pos.x=null;}a(i).on('mouseup vmouseup touchend touchcancel',j);a(i).on('mouseout vmouseout touchleave',j);a(document).keydown(partial(b.handle_keydown,c));a(document).keyup(partial(b.handle_keyup,c));a(i).mousewheel(partial(b.zoom,c),true);return c;};return function(a,b){var e=d(a,b);if(e===false){log.debug('state == false');return false;}var f={};for(var g in c)f[g]=partial(c[g],e);return f;};};IceCubeViewer=viewer(jQuery);VIEWER.Artists.linefit=function(a,b){log.info('linefit');var c=null;var d='frameobj' in b?b.frameobj:['MPEFit','SPEFit','LineFit'];if(Array.isArray(d)){for(var e=0;e<d.length;e++){c=a.frames[a.frameno][d[e]];if(c!=null&&c!=undefined)break;}}else c=a.frames[a.frameno][d];if(c==null||c==undefined){log.error('cannot find frame object '+d);return;}if(!('enable' in b))b.enable=true;if('handler' in b){var f=b.handler(c);if(f!=undefined&&f!=null&&f==false)b.enable=false;else if(f==true)b.enable=true;}if(b.scene_items!=null&&b.scene_items!=undefined){for(var e=b.scene_items.length-1;e>=0;e--)a.scene.remove(b.scene_items[e]);delete b.scene_items;}b.scene_items=[];if(!b.enable)return;var g=a.begin;if(g>a.current_time){log.info("not yet time for the line");return;}var h='scale' in b?b.scale:1000;var i='linewidth' in b?b.linewidth:3;var j='color' in b?b.color:0x000099;var k=new THREE.CylinderGeometry(0,i*5,i*10,32);var l=a.begin-c.time;var m=a.current_time-c.time;log.info('back'+l);log.info('forwards'+m);var n=new THREE.Geometry();n.vertices.push(new THREE.Vector3(c.pos.x-c.dir.x*h,c.pos.y-c.dir.y*h,c.pos.z-c.dir.z*h));n.vertices.push(new THREE.Vector3(c.pos.x+c.dir.x*l,c.pos.y+c.dir.y*l,c.pos.z+c.dir.z*l));n.vertices.push(new THREE.Vector3(c.pos.x+c.dir.x*m*c.speed,c.pos.y+c.dir.y*m*c.speed,c.pos.z+c.dir.z*m*c.speed));var o=new THREE.Line(n,new THREE.LineBasicMaterial({color:j,linewidth:i}));b.scene_items.push(o);a.scene.add(o);};VIEWER.Artists.accumulated_charge_counter=function(a){if(a.frameno>=a.maxframes||!(a.pulseseries in a.frames[a.frameno]))return;log.info('accumulated_charge_counter');var b=a.current_time;var c=a.frames[a.frameno][a.pulseseries];var d=$(a.element).find('div.drawing').first();var e=0.0;for(var f in c)for(var g=0;g<c[f].data.length;g++){var h=c[f].data[g].time;var i=c[f].data[g].charge;if(i<=0||h>b)continue;e+=i;}var j=(Math.round(e*100)/100)+'';if(j.indexOf('.')<0)j+='.00';else while(j.substr(j.indexOf('.')+1).length<2)j+='0';var k='Accumulated Charge: '+j+'pe';if($(d).children('.artist.accumulated_charge').length>0)$(d).children('.artist.accumulated_charge').text(k);else{var l='<div class="artist accumulated_charge">'+k+'</div>';$(d).prepend(l);}};VIEWER.Artists.accumulated_charge_counter_small=function(a){if(a.frameno>=a.maxframes||!(a.pulseseries in a.frames[a.frameno]))return;log.info('accumulated_charge_counter_small');var b=a.current_time;var c=a.frames[a.frameno][a.pulseseries];var d=$(a.element).find('div.drawing').first();var e=0.0;for(var f in c)for(var g=0;g<c[f].data.length;g++){var h=c[f].data[g].time;var i=c[f].data[g].charge;if(i<=0||h>b)continue;e+=i;}var j=(Math.round(e))+'';var k=j+'pe';if($(d).children('.artist.accumulated_charge').length>0)$(d).children('.artist.accumulated_charge').text(k);else{var l='<div class="artist accumulated_charge">'+k+'</div>';$(d).prepend(l);}};VIEWER.Artists.last_dom=function(a,b){if(a.frameno>=a.maxframes||!(a.pulseseries in a.frames[a.frameno]))return;log.info('last_dom');if(b==undefined||!('handler' in b)){log.warn('last_dom not configured');return;}var c=a.current_time;var d=a.frames[a.frameno][a.pulseseries];var e=b.handler;var f=[],g=0.0;for(var h in d)for(var i=0;i<d[h].data.length;i++){if(i>0)break;var j=d[h].data[i].time;var k=d[h].data[i].charge;var l=d[h].pmt;var m=d[h].om;var n=d[h].string;if(k<=0||j>c||j<g)continue;g=j;f=[n,m,l];}if(g<0.1)return;log.info('time = '+g+' last_dom = '+JSON.stringify(f));var o=a.geometry[f[0]][f[1]][f[2]].pos;if(e!=undefined&&o!=undefined){log.info('time = '+g+' pos = '+JSON.stringify(o));var p=e(o.x,o.y,o.z,g);if(p!=undefined&&p!=null&&p==false)b.highlight=false;else if(p==true)b.highlight=true;}else log.warn('last_dom - error with handler or pos');if(b.particlesystem!=null&&b.particlesystem!=undefined){a.scene.remove(b.particlesystem);delete b.particlesystem;}if(b.highlight==true){var q=new THREE.Geometry();q.vertices.push(new THREE.Vector3(o.x,o.y,o.z));var r={size:{type:'f',value:[100]},customColor:{type:'c',value:[new THREE.Color(0xFF1CDE)]}};if(a.webgl==true){if(b.particlesystem!=null&&b.particlesystem!=undefined){a.scene.remove(b.particlesystem);delete b.particlesystem;}b.particlesystem=new THREE.PointCloud(q,a.particlesphere_material(r));}else{b.particlesystem=new THREE.Object3D();var h=null;var s=null;for(var i=0;i<q.vertices.length;i++){s={size:r.size.value[0],customColor:r.customColor.value[0]};h=new THREE.Particle(a.particlesphere_material(s));h.position.set(q.vertices[i].x,q.vertices[i].y,q.vertices[i].z);b.particlesystem.add(h);}}a.scene.add(b.particlesystem);}};var to_csv=new csvWriter(',','');VIEWER.Artists.recopulse_csv=function(a,b){if(a.frameno>=a.maxframes||!(a.pulseseries in a.frames[a.frameno]))return;log.info('recopulse_csv');if(b==undefined||!('handler' in b)){log.warn('recopulse_csv not configured');return;}if(to_csv==undefined){log.error("csvWriter() is undefined");return;}var c=a.frames[a.frameno][a.pulseseries];var d=b.handler;var e=[['time','x','y','z']];var f={};for(var g in c)for(var h=0;h<c[g].data.length;h++){if(h>0)break;var i=c[g].data[h].time;var j=c[g].data[h].charge;var k=c[g].pmt;var l=c[g].om;var m=c[g].string;var n=a.geometry[m][l][k].pos;var o=""+n.x+","+n.y+","+n.z;if(j<=0||o in f)continue;f[o]=i;e.push([i,n.x,n.y,n.z]);}var p=to_csv.arrayToCSV(e);if(d!=undefined)d(p);else log.warn('recopulse_csv - error with handler');};VIEWER.Artists.coordinates=function(a,b){log.info('coordinates');if(!('enable' in b))b.enable=true;if('handler' in b){var c=b.handler();if(c!=undefined&&c!=null&&c==false)b.enable=false;else if(c==true)b.enable=true;}if(b.scene_items!=null&&b.scene_items!=undefined){for(var d=b.scene_items.length-1;d>=0;d--)a.scene.remove(b.scene_items[d]);delete b.scene_items;}b.scene_items=[];if(!b.enable)return;var e='scale' in b?b.scale:150;var f='linewidth' in b?b.linewidth:3;var g='x_color' in b?b.x_color:0x0000CC;var h='y_color' in b?b.y_color:0x00CC00;var i='z_color' in b?b.z_color:0xCC0000;var j=new THREE.CylinderGeometry(0,f*5,f*10,32);var k=-500;var l=new THREE.Geometry();l.vertices.push(new THREE.Vector3(0,0,k));l.vertices.push(new THREE.Vector3(e,0,k));var m=new THREE.Line(l,new THREE.LineBasicMaterial({color:g,linewidth:f,opacity:1,blending:THREE.AdditiveBlending,transparent:true}));b.scene_items.push(m);a.scene.add(m);var n=new THREE.Mesh(j,new THREE.MeshBasicMaterial({color:g}));n.rotation.x=Math.PI/2;n.rotation.z=-1*Math.PI/2;n.position.set(e,0,k);b.scene_items.push(n);a.scene.add(n);var o=new THREE.Geometry();o.vertices.push(new THREE.Vector3(0,0,k));o.vertices.push(new THREE.Vector3(0,e,k));var p=new THREE.Line(o,new THREE.LineBasicMaterial({color:h,linewidth:f,opacity:1,blending:THREE.AdditiveBlending,transparent:true}));b.scene_items.push(p);a.scene.add(p);var q=new THREE.Mesh(j,new THREE.MeshBasicMaterial({color:h}));q.rotation.y=Math.PI/2;q.position.set(0,e,k);b.scene_items.push(q);a.scene.add(q);var r=new THREE.Geometry();r.vertices.push(new THREE.Vector3(0,0,k));r.vertices.push(new THREE.Vector3(0,0,e+k));var s=new THREE.Line(r,new THREE.LineBasicMaterial({color:i,linewidth:f,opacity:1,blending:THREE.AdditiveBlending,transparent:true}));b.scene_items.push(s);a.scene.add(s);var t=new THREE.Mesh(j,new THREE.MeshBasicMaterial({color:i}));t.rotation.x=Math.PI/2;t.position.set(0,0,e+k);b.scene_items.push(t);a.scene.add(t);};viewer_wrapper=(function(a){var b={};var c={loaded:function(b){b.frames=[];for(var e=0;e<b.files.length;e++){if(b.files[e].dataret==undefined){alert('error loading file '+e);return;}var f={};if('eventids' in b.files[e])f=convertToAssociative(b.files[e].eventids);for(var g=0;g<b.files[e].dataret.length;g++){if('eventids' in b.files[e]&&!(g in f)){console.log('skipping file '+e+' frame '+g);continue;}b.frames.push({fileno:e,frameno:g,type:b.files[e].eventtype});}}if(b.randomize)fisher_yates(b.frames);b.frameno=0;c.get_frameno(b);d.draw_frame(b);d.draw(b);a('#loader').remove();if(b.loader_callback!=undefined){var h={};if(!b.no_viewer)for(var i in b.viewer)h[i]=b.viewer[i];for(var i in d)h[i]=partial(d[i],b);b.loader_callback(b,h);}},get_frameno:function(a){var b=location.hash;if(b!=undefined&&b!=null){var c=parseInt(b.substring(1),10);if(!isNaN(c))a.frameno=c;}},set_frameno:function(a){if(history.pushState)history.replaceState(null,null,'#'+a.frameno);else location.hash='#'+a.frameno;}};var d={next_frame:function(a){a.frameno+=1;if(a.frameno>=a.frames.length)if(a.loop)a.frameno=0;else return false;return true;},prev_frame:function(a){if(a.frameno<=0)if(a.loop)a.frameno=a.frames.length-1;else return false;else a.frameno-=1;return true;},draw_frame:function(a,b){if(a.no_viewer)return;if(a.files.length<1)a.viewer.set_gcd_data(a.gcdframe,a.dataframes);else{if(b==undefined)b=a.frameno;if(b<0||b>=a.frames.length){alert('frame number '+b+' out of range');return;}var c=a.frames[b].fileno;var d=a.frames[b].frameno;a.viewer.set_gcd_data(a.files[c].gcdret,[a.files[c].dataret[d]]);}},draw:function(b){var c={};if(!b.no_viewer)for(var e in b.viewer)c[e]=b.viewer[e];for(var e in d)c[e]=partial(d[e],b);b.right_col_callback(a(b.element).find('.viewer_right_col'),b,c);}};var e=function(b){b=a.extend({domain:'/',element:a(document),raw_viewer:false,no_viewer:false,navigation:undefined,show_fiducial:undefined,active_artists:undefined,right_col_offset:0,right_col_callback:function(a,b,c){return;},loader_callback:undefined,pulse_choose:undefined,preferred_pulseseries:undefined,bestfit_line:undefined,smart_color:undefined,force_color_times:undefined,color_begin:undefined,color_end:undefined,randomize:true,loop:true,files:[],frames:[],gcdframe:undefined,dataframes:undefined,frameno:0,downloader:undefined,viewer:undefined,webgl:undefined,allow_screenshot:false},b);b.downloader=partial(viewerAjaxCaller,b.domain+'/ajax');setDomain(b.domain);if(b.element){b.width=a(b.element).innerWidth();b.height=a(b.element).innerHeight();}if(!b.no_viewer){console.log('width:'+b.width+' height:'+b.height);var e='<div class="viewer" style="display:inline-block;vertical-align:top;';e+='width:'+(b.width-b.right_col_offset)+'px;height:'+b.height+'px"></div>';if(!b.raw_viewer&&b.right_col_offset>=10){e+='<div class="viewer_right_col" style="display:inline-block;vertical-align:top;';e+='width:'+(b.right_col_offset-10)+'px;margin-left:10px"></div>';}a(b.element).html(e);var f={domain:domain,element:a(b.element).children('div.viewer').first(),navigation:b.navigation||b.raw_viewer,raw_viewer:b.raw_viewer,show_fiducial:b.show_fiducial,active_artists:b.active_artists,webgl:b.webgl,allow_screenshot:b.allow_screenshot};if(b.preferred_pulseseries!=undefined)f.preferred_pulseseries=b.preferred_pulseseries;if(b.pulse_choose!=undefined)f.pulse_choose=b.pulse_choose;if(b.bestfit_line!=undefined)f.bestfit_line=b.bestfit_line;if(b.smart_color!=undefined)f.smart_color=b.smart_color;if(b.force_color_times!=undefined&&b.color_begin!=undefined&&b.color_end!=undefined){console.log('set color times');f.force_color_times=b.force_color_times;f.color_begin=b.color_begin;f.color_end=b.color_end;}if(b.files.length<1){console.log('make viewer with callback');b.viewer=IceCubeViewer(f,function(a){console.log('viewer callback');var c={};for(var e in a)c[e]=a[e];for(var e in d)c[e]=partial(d[e],b);if(b.loader_callback!=undefined)b.loader_callback(b,c);});}else{console.log('load files and make viewer with callback');b.viewer=IceCubeViewer(f,function(d){e='<div id="loader" style="width:'+b.width+'px;height:'+b.height+'px;';e+='margin:0;left:0;top:0;padding:0;position:fixed;z-index:10;display:block;text-align:center;vertical-align:center;background-color:#999">';e+='<h1 style="width:200px;height:50px;text-align:center;margin:'+(b.height/2-50)+'px auto 15px;">Loading...</h1>';e+='<img src="'+domain+'/static/loader.gif" height="50" width="50" style="margin:auto;text-align:center" /></div>';a(b.element).prepend(e);var f={};for(var g=0;g<b.files.length;g++){f[g+'g']={'function':'getGCD','gcd_filename':b.files[g].gcdfile};f[g+'d']={'function':'getI3','i3_filename':b.files[g].datafile,'frame_type':b.files[g].frametype};if('datakeys' in b.files[g])f[g+'d'].keys=b.files[g].datakeys.join(',');}file_loader({waiting:f,downloader:b.downloader,callback:function(a,d){console.log('callback');if(!isAssociativeEmpty(d))alert('failed to load all files');else{for(var e=0;e<b.files.length;e++){b.files[e].gcdret=a[e+'g'].data;b.files[e].dataret=a[e+'d'].data;}c.loaded(b);}}})('start');});}if(!b.viewer){console.warn('removing viewer');a('#loader').remove();a('#main').remove();Detector.addGetWebGLMessage();return false;}b.viewer.set_center(50,50,-50);b.viewer.set_camera(1250,-460,300);}else if(b.files.length>0){console.log('load files without viewer');e='<div id="loader" style="width:'+b.width+'px;height:'+b.height+'px;';e+='margin:0;left:0;top:0;padding:0;position:fixed;z-index:10;display:block;text-align:center;vertical-align:center;background-color:#999">';e+='<h1 style="width:200px;height:50px;text-align:center;margin:'+(b.height/2-50)+'px auto 15px;">Loading...</h1>';e+='<img src="'+domain+'/static/loader.gif" height="50" width="50" style="margin:auto;text-align:center" /></div>';a(b.element).prepend(e);var g={};for(var h=0;h<b.files.length;h++){g[h+'g']={'function':'getGCD','gcd_filename':b.files[h].gcdfile};g[h+'d']={'function':'getI3','i3_filename':b.files[h].datafile,'frame_type':b.files[h].frametype};if('datakeys' in b.files[h])g[h+'d'].keys=b.files[h].datakeys.join(',');}file_loader({waiting:g,downloader:b.downloader,callback:function(a,d){console.log('callback');if(!isAssociativeEmpty(d))alert('failed to load all files');else{for(var e=0;e<b.files.length;e++){b.files[e].gcdret=a[e+'g'].data;b.files[e].dataret=a[e+'d'].data;}c.loaded(b);}}})('start');}return b;};return function(a){var b=e(a);console.log('init ret:'+b);var c={};for(var f in b.viewer)c[f]=b.viewer[f];for(var f in d)c[f]=partial(d[f],b);return c;};})(jQuery);